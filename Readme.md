# Transferwiser

This service acts as a read-only interface for users to see the list of transactions of a transferwise account.

The authentication with the service used client certificates. The server only accepts valid and non-revoked certificates
generated from the configured CA certificate.

The ssl connection uses a certificate generated by Let's Encrypt. It's all automatic. The only requirement is to open an
unencrypted port for the challenges.

There is only one endpoint in the server, which is `/transfers.csv`, which returns the latest transfers from
Transferwise in a CSV format.

# Config

All configuration uses environment variables:

- `TRANSFERWISER_PORT` is the http port where the service will be served. Default `8080`
- `TRANSFERWISER_LETSENCRYPTPORT` is the http port where letsencrypt will run the challenges. Default `8081`
- `TRANSFERWISER_TWHOST` is the transferwise host to use. Default `api.sandbox.transferwise.tech`
- `TRANSFERWISER_TWAPITOKEN` is the transferwise API Token. Required.
- `TRANSFERWISER_TWPROFILE` is the profile ID of the account in transferwise. Required.
- `TRANSFERWISER_CACERT` CA certificate. Required.
- `TRANSFERWISER_CERTFILE` Server cert file to use. Keep empty to use automatic TLS with Let's encrypt.
- `TRANSFERWISER_KEYFILE` Server key file to use. Keep empty to use automatic TLS with Let's encrypt.

# Development

There are some self-signed certificates in the `certs/` folder. All passphrases are `test`.

To configure the CA cert run the following:
```
export TRANSFERWISER_CACERT=$(cat certs/ca.crt)
```

Keep in mind the automatic TLS with Let's encrypt requires access to your machine. Most probably is a good idea to use 
the self signed certificates for that too.

```
export TRANSFERWISER_CERTFILE=$(pwd)/certs/server.crt
export TRANSFERWISER_KEYFILE=$(pwd)/certs/server.key
```

The rest of configuration environment variables depend on your preferences.

To test your API now, use the following: 

```
curl --insecure https://localhost:8080/transfers.csv --cert certs/client.pem
```

# ECS issues

There's one issue running this service on ECS. The web interface doesn't allow multiline environment variables in any
way.

To solve this it's necessary to push the container definition from the command line using the `aws` tool.

The command to run will look like this:

```
aws ecs register-task-definition --profile=<PROFILE> --region <REGION> --cli-input-json file://ecs.json
```

An example of `ecs.json` file would be:

```
{
    "containerDefinitions": [
        {
            "portMappings": [
                {
                    "hostPort": 80,
                    "protocol": "tcp",
                    "containerPort": 80
                },
                {
                    "hostPort": 443,
                    "protocol": "tcp",
                    "containerPort": 443
                }
            ],
            "cpu": 0,
            "environment": [
                {
                    "name": "TRANSFERWISER_CACERT",
                    "value": "-----BEGIN CERTIFICATE-----\nyour\ncertificate\nhere\n-----END CERTIFICATE-----"
                },
                {
                    "name": "TRANSFERWISER_LETSENCRYPTPORT",
                    "value": "80"
                },
                {
                    "name": "TRANSFERWISER_PORT",
                    "value": "443"
                },
                {
                    "name": "TRANSFERWISER_TWAPITOKEN",
                    "value": "<YOUR_TOKEN>"
                },
                {
                    "name": "TRANSFERWISER_TWHOST",
                    "value": "api.sandbox.transferwise.tech"
                },
                {
                    "name": "TRANSFERWISER_TWPROFILE",
                    "value": "<YOUR_TRANSFERWISE_PROFILE_ID>"
                }
            ],
            "mountPoints": [
                {
                    "containerPath": "/.cache",
                    "sourceVolume": "tls-cache"
                }
            ],
            "memory": 256,
            "memoryReservation": 128,
            "volumesFrom": [],
            "image": "endian/transferwiser:latest",
            "essential": true,
            "name": "transferwiser"
        }
    ],
    "family": "transferwiser",
    "volumes": [
        {
            "name": "tls-cache"
        }
    ],
    "placementConstraints": []
}

```
